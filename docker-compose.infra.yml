# Infrastructure stack - Traefik + Komodo
# Deploy first: docker compose -f docker-compose.infra.yml up -d
services:
  traefik:
    image: ghcr.io/traefik/traefik:3.4
    container_name: traefik
    restart: always
    environment:
      - CLOUDFLARE_EMAIL=${CLOUDFLARE_EMAIL}
      - CLOUDFLARE_DNS_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}
      - CLOUDFLARE_ZONE_API_TOKEN=${CLOUDFLARE_ZONE_API_TOKEN}
      - LETS_ENCRYPT_EMAIL=${LETS_ENCRYPT_EMAIL}
    command:
      - --ping=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=docker-compose-nas
      - --entrypoints.web.address=:80
      - --entrypoints.web-secure.address=:443
      - --entrypoints.web.http.redirections.entryPoint.to=web-secure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      - --certificatesresolvers.myresolver.acme.dnschallenge=${DNS_CHALLENGE:-true}
      - --certificatesresolvers.myresolver.acme.dnschallenge.provider=${DNS_CHALLENGE_PROVIDER:-cloudflare}
      - --certificatesresolvers.myresolver.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53
      - --certificatesresolvers.myresolver.acme.caserver=${LETS_ENCRYPT_CA_SERVER:-https://acme-v02.api.letsencrypt.org/directory}
      - --certificatesresolvers.myresolver.acme.email=${LETS_ENCRYPT_EMAIL}
      - --certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${CONFIG_ROOT:-.}/letsencrypt:/letsencrypt
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    extra_hosts:
      - host.docker.internal:172.17.0.1
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 1m
      retries: 10

  komodo-ferretdb:
    image: ghcr.io/ferretdb/ferretdb:1
    container_name: komodo-ferretdb
    restart: always
    labels:
      - komodo.skip=true
    volumes:
      - ${CONFIG_ROOT:-.}/komodo-sqlite:/state
    environment:
      - FERRETDB_HANDLER=sqlite

  komodo-core:
    image: ghcr.io/moghtech/komodo-core:latest
    container_name: komodo-core
    restart: always
    depends_on:
      - komodo-ferretdb
    ports:
      - "9120:9120"
    volumes:
      - ${CONFIG_ROOT:-.}/komodo-repo-cache:/repo-cache
    environment:
      - KOMODO_DATABASE_ADDRESS=komodo-ferretdb
      - KOMODO_HOST=${KOMODO_HOST:-http://localhost:9120}
      - KOMODO_TITLE=${KOMODO_TITLE:-Docker-Compose NAS Komodo}
      - KOMODO_FIRST_SERVER=https://komodo-periphery:8120
      - KOMODO_LOCAL_AUTH=${KOMODO_LOCAL_AUTH:-true}
      - KOMODO_ENABLE_NEW_USERS=${KOMODO_ENABLE_NEW_USERS:-false}
      - KOMODO_TRANSPARENT_MODE=${KOMODO_TRANSPARENT_MODE:-false}
      - KOMODO_DISABLE_CONFIRM_DIALOG=${KOMODO_DISABLE_CONFIRM_DIALOG:-false}
      - KOMODO_MONITORING_INTERVAL=${KOMODO_MONITORING_INTERVAL:-15-sec}
      - KOMODO_RESOURCE_POLL_INTERVAL=${KOMODO_RESOURCE_POLL_INTERVAL:-5-min}
      - KOMODO_WEBHOOK_SECRET=${KOMODO_WEBHOOK_SECRET:-}
      - KOMODO_JWT_SECRET=${KOMODO_JWT_SECRET:-}
      - KOMODO_DISABLE_USER_REGISTRATION=${KOMODO_DISABLE_USER_REGISTRATION:-false}
      - KOMODO_DISABLE_NON_ADMIN_CREATE=${KOMODO_DISABLE_NON_ADMIN_CREATE:-false}
      - KOMODO_JWT_TTL=${KOMODO_JWT_TTL:-1-day}
      - KOMODO_PASSKEY=${KOMODO_PASSKEY:-default-passkey-change-me}
      - TZ=${TIMEZONE:-America/New_York}
      - PERIPHERY_DOCKER_NETWORK=docker-compose-nas
    labels:
      - komodo.skip=true
      - traefik.enable=true
      - traefik.http.routers.komodo.rule=(Host(`${KOMODO_HOSTNAME}`))
      - traefik.http.routers.komodo.middlewares=chain-authentik@file
      - traefik.http.routers.komodo.tls=true
      - traefik.http.routers.komodo.tls.certresolver=myresolver
      - traefik.http.services.komodo.loadbalancer.server.port=9120
      - traefik.docker.network=docker-compose-nas

  komodo-periphery:
    image: ghcr.io/moghtech/komodo-periphery:latest
    container_name: komodo-periphery
    restart: always
    ports:
      - "8120:8120"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/proc
      - ${CONFIG_ROOT:-.}/komodo-periphery:/etc/komodo
      # - ${PWD}:${PWD}
      - ${DATA_ROOT:-/volume1/data}:${DATA_ROOT:-/volume1/data}
    environment:
      - PERIPHERY_ROOT_DIRECTORY=/etc/komodo
      - PERIPHERY_PASSKEYS=${KOMODO_PASSKEY:-default-passkey-change-me}
      - PERIPHERY_SSL_ENABLED=${PERIPHERY_SSL_ENABLED:-false}
      - PERIPHERY_REPO_DIR=/etc/komodo/repos
      - PERIPHERY_STACK_DIR=/etc/komodo/stacks
      - TZ=${TIMEZONE:-America/New_York}
    labels:
      - komodo.skip=true

  watchtower:
    image: ghcr.io/containrrr/watchtower:latest
    container_name: watchtower
    restart: always
    environment:
      - WATCHTOWER_CLEANUP=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal
    restart: always
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  authentik-postgres:
    container_name: authentik-postgres
    environment:
      POSTGRES_DB: ${AUTHENTIK_POSTGRES_DB:-authentik}
      POSTGRES_PASSWORD: ${AUTHENTIK_POSTGRES_PASSWORD}
      POSTGRES_USER: ${AUTHENTIK_POSTGRES_USER}
    healthcheck:
      interval: 30s
      retries: 5
      start_period: 20s
      test:
        - CMD-SHELL
        - pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}
      timeout: 5s
    image: docker.io/library/postgres:16-alpine
    restart: unless-stopped
    volumes:
      - ${CONFIG_ROOT:-.}/authentik/postgres:/var/lib/postgresql/data

  authentik-server:
    container_name: authentik-server
    command: server
    depends_on:
      authentik-postgres:
        condition: service_healthy
    environment:
      AUTHENTIK_POSTGRESQL__HOST: authentik-postgres
      AUTHENTIK_POSTGRESQL__NAME: ${AUTHENTIK_POSTGRES_DB:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_POSTGRES_PASSWORD}
      AUTHENTIK_POSTGRESQL__USER: ${AUTHENTIK_POSTGRES_USER}
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?secret key required}
    image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.10.2}
    ports:
      - ${COMPOSE_PORT_HTTP:-9000}:9000
      - ${COMPOSE_PORT_HTTPS:-9443}:9443
    restart: unless-stopped
    volumes:
      - ${CONFIG_ROOT:-.}/authentik/media:/media
      - ${CONFIG_ROOT:-.}/authentik/custom-templates:/templates
    labels:
      - traefik.enable=true
      - traefik.http.routers.authentik.entrypoints=web-secure
      - traefik.http.routers.authentik.rule=Host(`${AUTHENTIK_HOSTNAME}`)
      - traefik.http.routers.authentik.tls=true
      - traefik.http.routers.authentik.tls.certresolver=myresolver
      - traefik.http.services.authentik.loadbalancer.server.port=9000
      - traefik.docker.network=docker-compose-nas
      
  authentik-worker:
    container_name: authentik-worker
    command: worker
    depends_on:
      authentik-postgres:
        condition: service_healthy
    environment:
      AUTHENTIK_POSTGRESQL__HOST: authentik-postgres
      AUTHENTIK_POSTGRESQL__NAME: ${AUTHENTIK_POSTGRES_DB:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_POSTGRES_PASSWORD}
      AUTHENTIK_POSTGRESQL__USER: ${AUTHENTIK_POSTGRES_USER}
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?secret key required}
    image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.10.2}
    restart: unless-stopped
    user: root
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${CONFIG_ROOT:-.}/authentik/media:/media
      - ${CONFIG_ROOT:-.}/authentik/certs:/certs
      - ${CONFIG_ROOT:-.}/authentik/custom-templates:/templates

  authentik-proxy:
      image: ghcr.io/goauthentik/proxy
      container_name: authentik-proxy
      environment:
          AUTHENTIK_HOST: https://${AUTHENTIK_HOSTNAME}
          AUTHENTIK_INSECURE: "false"
          AUTHENTIK_TOKEN: token-generated-by-authentik
          # Starting with 2021.9, you can optionally set this too
          # when authentik_host for internal communication doesn't match the public URL
          # AUTHENTIK_HOST_BROWSER: https://external-domain.tld
      labels:
          traefik.enable: true
          traefik.port: 9000
          traefik.http.routers.authentik.rule: Host(`${AUTHENTIK_HOSTNAME}`) && PathPrefix(`/outpost.goauthentik.io/`)
          # `authentik-proxy` refers to the service name in the compose file.
          traefik.http.middlewares.authentik.forwardauth.address: http://authentik-proxy:9000/outpost.goauthentik.io/auth/traefik
          traefik.http.middlewares.authentik.forwardauth.trustForwardHeader: true
          traefik.http.middlewares.authentik.forwardauth.authResponseHeaders: X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version
      restart: unless-stopped

networks:
  default:
    name: docker-compose-nas
    external: true
